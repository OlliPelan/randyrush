<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ðŸ’Ž Bejeweled ðŸ’Ž</title>
    <style>
        * {
            -webkit-tap-highlight-color: transparent;
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html {
            touch-action: manipulation;
        }

        body {
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 10px;
            font-family: Arial, sans-serif;
            overflow: hidden;
            position: relative;
            touch-action: manipulation;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 15px 25px;
            margin-bottom: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            width: 90%;
            max-width: 380px;
        }

        h1 {
            margin: 0 0 10px 0;
            font-size: 28px;
            text-align: center;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-weight: bold;
        }

        .stats {
            display: flex;
            justify-content: space-around;
            font-size: 18px;
            font-weight: bold;
        }

        .score {
            color: #667eea;
        }

        .moves {
            color: #764ba2;
        }

        .combo-display {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 48px;
            font-weight: bold;
            color: #ffd700;
            text-shadow: 0 0 20px rgba(255, 215, 0, 0.8), 0 0 40px rgba(255, 215, 0, 0.6);
            z-index: 1000;
            animation: combo-pop 1s ease-out;
            pointer-events: none;
            display: none;
        }

        .combo-display.show {
            display: block;
        }

        .board-container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 10px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            position: relative;
            width: 90%;
            max-width: 380px;
            box-sizing: border-box;
        }

        .board {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 2px;
            position: relative;
        }

        .gem {
            aspect-ratio: 1;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 26px;
            cursor: pointer;
            border: 3px solid rgba(255, 255, 255, 0.5);
            touch-action: manipulation;
            box-sizing: border-box;
        }

        .gem.selected {
            border-color: #ffffff;
        }

        .gem.matched {
            transition: transform 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55), opacity 0.5s ease-out !important;
            transform: scale(0) rotate(180deg) !important;
            opacity: 0 !important;
        }

        .particle {
            position: absolute;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            pointer-events: none;
            z-index: 100;
        }

        .reset-button {
            margin-top: 20px;
            padding: 15px 40px;
            font-size: 18px;
            font-weight: bold;
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            transition: transform 0.2s;
            width: 90%;
            max-width: 380px;
            touch-action: manipulation;
        }

        .reset-button:active {
            transform: scale(0.95);
        }

        .game-over {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.85);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            animation: fade-in 0.3s ease-out;
        }

        .game-over.show {
            display: flex;
        }

        .game-over-content {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 40px;
            border-radius: 20px;
            text-align: center;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
            color: white;
        }

        .game-over-content h2 {
            font-size: 36px;
            margin: 0 0 20px 0;
        }

        .game-over-content p {
            font-size: 28px;
            margin: 0 0 30px 0;
            font-weight: bold;
        }

        .game-over-content button {
            padding: 15px 40px;
            font-size: 18px;
            font-weight: bold;
            background: white;
            color: #667eea;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            touch-action: manipulation;
        }

        @keyframes particle-burst-0 {
            0% {
                transform: translate(-50%, -50%) translateX(0) translateY(0) scale(1);
                opacity: 1;
            }
            100% {
                transform: translate(-50%, -50%) translateX(50px) translateY(50px) scale(0);
                opacity: 0;
            }
        }

        @keyframes particle-burst-1 {
            0% {
                transform: translate(-50%, -50%) translateX(0) translateY(0) scale(1);
                opacity: 1;
            }
            100% {
                transform: translate(-50%, -50%) translateX(60px) translateY(30px) scale(0);
                opacity: 0;
            }
        }

        @keyframes particle-burst-2 {
            0% {
                transform: translate(-50%, -50%) translateX(0) translateY(0) scale(1);
                opacity: 1;
            }
            100% {
                transform: translate(-50%, -50%) translateX(40px) translateY(60px) scale(0);
                opacity: 0;
            }
        }

        @keyframes combo-pop {
            0% {
                transform: translate(-50%, -50%) scale(0);
                opacity: 0;
            }
            50% {
                transform: translate(-50%, -50%) scale(1.2);
                opacity: 1;
            }
            100% {
                transform: translate(-50%, -50%) scale(1);
                opacity: 0;
            }
        }

        @keyframes fade-in {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ðŸ’Ž Bejeweled ðŸ’Ž</h1>
        <div class="stats">
            <div class="score">Score: <span id="score">0</span></div>
            <div class="moves">Moves: <span id="moves">30</span></div>
        </div>
    </div>

    <div class="combo-display" id="comboDisplay"></div>

    <div class="board-container">
        <div class="board" id="board"></div>
    </div>

    <button class="reset-button" onclick="resetGame()">ðŸ”„ New Game</button>

    <div class="game-over" id="gameOver">
        <div class="game-over-content">
            <h2>ðŸ’Ž Game Over! ðŸ’Ž</h2>
            <p>Final Score: <span id="finalScore">0</span></p>
            <button onclick="resetGame()">Play Again</button>
        </div>
    </div>

    <script>
        const gemTypes = [
            { emoji: 'ðŸ’Ž', color: '#00d4ff', id: 0 },
            { emoji: 'ðŸ’š', color: '#00ff88', id: 1 },
            { emoji: 'ðŸ’›', color: '#ffd700', id: 2 },
            { emoji: 'ðŸ”´', color: '#ff4757', id: 3 },
            { emoji: 'ðŸ’œ', color: '#a55eea', id: 4 }
        ];

        const BOARD_SIZE = 8;
        let board = [];
        let selectedGem = null;
        let score = 0;
        let moves = 30;
        let isAnimating = false;
        let combo = 0;

        // Lock orientation upright
        if (screen.orientation && screen.orientation.lock) {
            screen.orientation.lock('portrait').catch(() => {});
        }

        function initializeBoard() {
            board = [];
            for (let row = 0; row < BOARD_SIZE; row++) {
                const newRow = [];
                for (let col = 0; col < BOARD_SIZE; col++) {
                    let gemType;
                    let attempts = 0;
                    do {
                        gemType = gemTypes[Math.floor(Math.random() * gemTypes.length)];
                        attempts++;
                    } while (
                        attempts < 50 &&
                        ((col >= 2 && newRow[col - 1]?.type.id === gemType.id && newRow[col - 2]?.type.id === gemType.id) ||
                        (row >= 2 && board[row - 1]?.[col]?.type.id === gemType.id && board[row - 2]?.[col]?.type.id === gemType.id))
                    );

                    newRow.push({
                        type: gemType,
                        id: `${row}-${col}-${Date.now()}-${Math.random()}`,
                        matched: false
                    });
                }
                board.push(newRow);
            }
            isAnimating = false;
            renderBoard();
        }

        function renderBoard() {
            const boardElement = document.getElementById('board');
            boardElement.innerHTML = '';

            for (let row = 0; row < BOARD_SIZE; row++) {
                for (let col = 0; col < BOARD_SIZE; col++) {
                    const gem = board[row][col];
                    const gemElement = document.createElement('div');
                    gemElement.className = 'gem';
                    gemElement.dataset.row = row;
                    gemElement.dataset.col = col;
                    gemElement.textContent = gem.type.emoji;

                    const isSelected = selectedGem?.row === row && selectedGem?.col === col;
                    
                    gemElement.style.background = isSelected
                        ? `linear-gradient(135deg, ${gem.type.color}, #ffffff)`
                        : `linear-gradient(135deg, ${gem.type.color}, ${gem.type.color}dd)`;
                    
                    gemElement.style.boxShadow = isSelected
                        ? `0 0 20px ${gem.type.color}, 0 0 40px ${gem.type.color}88`
                        : `0 4px 12px ${gem.type.color}44`;

                    if (isSelected) {
                        gemElement.classList.add('selected');
                    }

                    if (gem.matched) {
                        gemElement.classList.add('matched');
                    }

                    gemElement.onclick = () => handleGemClick(row, col);
                    gemElement.ontouchstart = (e) => {
                        e.preventDefault();
                        handleGemClick(row, col);
                    };

                    boardElement.appendChild(gemElement);
                }
            }

            document.getElementById('score').textContent = score;
            document.getElementById('moves').textContent = moves;

            if (moves === 0) {
                document.getElementById('finalScore').textContent = score;
                document.getElementById('gameOver').classList.add('show');
            }
        }

        function playSound(type, frequency = 1) {
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();

                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);

                if (type === 'match') {
                    oscillator.frequency.value = 600 * frequency;
                    gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.4);
                    oscillator.start(audioContext.currentTime);
                    oscillator.stop(audioContext.currentTime + 0.4);
                } else if (type === 'swap') {
                    oscillator.frequency.value = 300;
                    gainNode.gain.setValueAtTime(0.15, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.1);
                    oscillator.start(audioContext.currentTime);
                    oscillator.stop(audioContext.currentTime + 0.1);
                } else if (type === 'invalid') {
                    oscillator.frequency.value = 150;
                    gainNode.gain.setValueAtTime(0.2, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.15);
                    oscillator.start(audioContext.currentTime);
                    oscillator.stop(audioContext.currentTime + 0.15);
                } else if (type === 'combo') {
                    oscillator.frequency.value = 1000;
                    gainNode.gain.setValueAtTime(0.4, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
                    oscillator.start(audioContext.currentTime);
                    oscillator.stop(audioContext.currentTime + 0.5);
                }
            } catch (e) {
                // Audio context failed, continue silently
            }
        }

        function createParticles(row, col, color) {
            const boardContainer = document.querySelector('.board-container');
            for (let i = 0; i < 12; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                particle.style.left = `${col * 45 + 22}px`;
                particle.style.top = `${row * 45 + 22}px`;
                particle.style.background = color;
                particle.style.boxShadow = `0 0 10px ${color}`;
                particle.style.animation = `particle-burst-${Math.floor(Math.random() * 3)} 0.8s ease-out forwards`;
                particle.style.transform = `translate(-50%, -50%) rotate(${(Math.PI * 2 * i) / 12}rad)`;
                
                boardContainer.appendChild(particle);
                
                setTimeout(() => {
                    particle.remove();
                }, 800);
            }
        }

        function findMatches(testBoard) {
            const matched = Array(BOARD_SIZE).fill(null).map(() => Array(BOARD_SIZE).fill(false));

            // Check horizontal matches
            for (let row = 0; row < BOARD_SIZE; row++) {
                let matchStart = 0;
                for (let col = 1; col <= BOARD_SIZE; col++) {
                    if (col === BOARD_SIZE || testBoard[row][col].type.id !== testBoard[row][matchStart].type.id) {
                        const matchLength = col - matchStart;
                        if (matchLength >= 3) {
                            for (let i = matchStart; i < col; i++) {
                                matched[row][i] = true;
                            }
                        }
                        matchStart = col;
                    }
                }
            }

            // Check vertical matches
            for (let col = 0; col < BOARD_SIZE; col++) {
                let matchStart = 0;
                for (let row = 1; row <= BOARD_SIZE; row++) {
                    if (row === BOARD_SIZE || testBoard[row][col].type.id !== testBoard[matchStart][col].type.id) {
                        const matchLength = row - matchStart;
                        if (matchLength >= 3) {
                            for (let i = matchStart; i < row; i++) {
                                matched[i][col] = true;
                            }
                        }
                        matchStart = row;
                    }
                }
            }

            const matchList = [];
            for (let row = 0; row < BOARD_SIZE; row++) {
                for (let col = 0; col < BOARD_SIZE; col++) {
                    if (matched[row][col]) {
                        matchList.push({ row, col });
                    }
                }
            }

            return matchList;
        }

        function handleGemClick(row, col) {
            if (isAnimating || moves <= 0) return;

            if (!selectedGem) {
                selectedGem = { row, col };
                playSound('swap');
                renderBoard();
            } else {
                // If clicking the same gem, unselect it
                if (selectedGem.row === row && selectedGem.col === col) {
                    selectedGem = null;
                    playSound('swap');
                    renderBoard();
                    return;
                }

                const rowDiff = Math.abs(selectedGem.row - row);
                const colDiff = Math.abs(selectedGem.col - col);

                if ((rowDiff === 1 && colDiff === 0) || (rowDiff === 0 && colDiff === 1)) {
                    attemptSwap(selectedGem.row, selectedGem.col, row, col);
                } else {
                    selectedGem = { row, col };
                    playSound('swap');
                    renderBoard();
                }
            }
        }

        function attemptSwap(row1, col1, row2, col2) {
            isAnimating = true;

            // Swap
            const temp = board[row1][col1];
            board[row1][col1] = board[row2][col2];
            board[row2][col2] = temp;

            const matches = findMatches(board);

            if (matches.length > 0) {
                selectedGem = null;
                moves--;
                playSound('swap');
                renderBoard();

                setTimeout(() => {
                    processMatches(1);
                }, 300);
            } else {
                // Swap back
                const temp = board[row1][col1];
                board[row1][col1] = board[row2][col2];
                board[row2][col2] = temp;

                playSound('invalid');
                selectedGem = null;
                isAnimating = false;
                renderBoard();
            }
        }

        function processMatches(currentCombo) {
            const matches = findMatches(board);

            if (matches.length > 0) {
                combo = currentCombo;
                
                const comboDisplay = document.getElementById('comboDisplay');
                if (currentCombo > 1) {
                    comboDisplay.textContent = `${currentCombo}x COMBO! ðŸ”¥`;
                    comboDisplay.classList.add('show');
                    playSound('combo');
                    setTimeout(() => {
                        comboDisplay.classList.remove('show');
                    }, 1000);
                }

                playSound('match', 1 + currentCombo * 0.2);

                matches.forEach(({ row, col }) => {
                    board[row][col].matched = true;
                    createParticles(row, col, board[row][col].type.color);
                });

                score += matches.length * 10 * currentCombo;
                renderBoard();

                setTimeout(() => {
                    removeMatchedAndDrop(currentCombo);
                }, 500);
            } else {
                combo = 0;
                isAnimating = false;
            }
        }

        function removeMatchedAndDrop(currentCombo) {
            // Drop existing gems and fill from top
            for (let col = 0; col < BOARD_SIZE; col++) {
                const column = [];

                // Collect non-matched gems from bottom to top
                for (let row = BOARD_SIZE - 1; row >= 0; row--) {
                    if (!board[row][col].matched) {
                        column.push(board[row][col]);
                    }
                }

                // Fill with new gems at the top
                while (column.length < BOARD_SIZE) {
                    column.push({
                        type: gemTypes[Math.floor(Math.random() * gemTypes.length)],
                        id: `new-${col}-${Date.now()}-${Math.random()}`,
                        matched: false
                    });
                }

                // Place back into board
                for (let row = 0; row < BOARD_SIZE; row++) {
                    board[row][col] = column[BOARD_SIZE - 1 - row];
                }
            }

            renderBoard();

            // Check for new matches after a delay
            setTimeout(() => {
                const newMatches = findMatches(board);
                if (newMatches.length > 0) {
                    processMatches(currentCombo + 1);
                } else {
                    combo = 0;
                    isAnimating = false;
                }
            }, 400);
        }

        function resetGame() {
            score = 0;
            moves = 30;
            combo = 0;
            selectedGem = null;
            isAnimating = false;
            document.getElementById('gameOver').classList.remove('show');
            initializeBoard();
        }

        // Initialize game on load
        initializeBoard();
    </script>
</body>
</html>